name: Atualizar dados SUSEP

on:
  schedule:
    - cron: '0 9 * * 1'  # toda segunda-feira às 9h UTC (4h BRT)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Mantenha esta permissão
      # Adicione a permissão para criar releases, se ainda não tiver
      # Se a job já tem 'contents: write', 'releases: write' é geralmente incluído,
      # mas é bom ser explícito se houver problemas.
      # releases: write

    steps:
      - name: Clonar repositório
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependências
        run: pip install pandas openpyxl xlrd requests certifi urllib3

      - name: Configurar Git LFS
        run: |
          git lfs install
          git lfs track "data/*.csv"
          git add .gitattributes || true

      - name: Rodar script de atualização
        run: python scripts/main.py

      - name: Commit e push dos arquivos extraídos
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .gitattributes data/*.csv || true
          git diff --cached --quiet || (git commit -m "Atualização automática dos dados SUSEP" && git push)

      # --- NOVO BLOCO: Criar Release e Anexar CSVs ---
      - name: Criar GitHub Release com CSVs
        if: success() # Garante que só roda se os passos anteriores forem bem-sucedidos
        id: create_release # Id para referenciar no próximo passo
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Token padrão do GitHub Actions
        with:
          tag_name: data-${{ github.run_number }} # Tag única para cada release
          release_name: Dados SUSEP - ${{ github.event.release.tag_name }} # Nome do release
          draft: false
          prerelease: false

      - name: Upload CSVs para o Release
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # URL de upload do release criado
          asset_path: ./data/Ses_cias.csv # Caminho para o seu arquivo CSV
          asset_name: Ses_cias.csv # Nome que o arquivo terá no release
          asset_content_type: text/csv # Tipo de conteúdo do arquivo

      - name: Upload Ses_ramos.csv para o Release
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./data/Ses_ramos.csv
          asset_name: Ses_ramos.csv
          asset_content_type: text/csv

      - name: Upload Ses_seguros.csv para o Release
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./data/Ses_seguros.csv
          asset_name: Ses_seguros.csv
          asset_content_type: text/csv
      # --- FIM DO NOVO BLOCO ---
